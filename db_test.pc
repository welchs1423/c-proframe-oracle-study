#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlda.h>
#include <sqlca.h>

EXEC SQL INCLUDE sqlca;

/* [전역 호스트 변수 선언] */
EXEC SQL BEGIN DECLARE SECTION;
    char *user_id = "system/Password123!@127.0.0.1:1521/xepdb1";
    char acc_no[20];
    char trans_type[20]; /* 한글 '입금/출금'을 담을 새 변수 추가 */
    char target_acc[20];    // 이체 대상 계좌번호
    VARCHAR user_name[20];
    VARCHAR target_name[20];    // 이체 대상 고객명
    long current_balance;
    long amount;
EXEC SQL END DECLARE SECTION;

/* 숫자에 천 단위 콤마를 찍어주는 함수 */
char* format_comma(long num) {
    static char buf[30];
    char temp[30];
    int i, j = 0, len;
    sprintf(temp, "%ld", num);
    len = strlen(temp);
    for (i = 0; i < len; i++) {
        if (i > 0 && (len - i) % 3 == 0) {
            buf[j++] = ',';
        }
        buf[j++] = temp[i];
    }
    buf[j] = '\0';
    return buf;
}

/* 에러 핸들링 함수 */
void sql_error(char *msg) {
    printf("\n[치명적 오류] %s\n", msg);
    printf("SQL Code: %d\n", sqlca.sqlcode);
    printf("Message: %.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
    EXEC SQL ROLLBACK WORK RELEASE;
    exit(1);
}

/* 1. 계좌 로그인 함수 */
int login() {
    printf("\n작업할 계좌번호를 입력하세요 (예: 110-123-456): ");
    scanf("%s", acc_no);

    EXEC SQL SELECT USER_NAME INTO :user_name FROM ACCOUNT WHERE ACC_NO = :acc_no;

    if (sqlca.sqlcode == 1403) {
        printf("[실패] 등록되지 않은 계좌번호입니다.\n");
        return 0;
    } else if (sqlca.sqlcode != 0) {
        printf("[오류] DB 조회 중 에러 발생 (Code: %d)\n", sqlca.sqlcode);
        return 0;
    }

    user_name.arr[user_name.len] = '\0';
    printf("\n[환영합니다] %s 고객님, 인증되었습니다.\n", user_name.arr);
    return 1;
}

/* 2. 잔액 조회 함수 */
void check_balance() {
    EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        printf("\n[잔액조회] %s 고객님의 현재 잔액은 %s원 입니다.\n", user_name.arr, format_comma(current_balance));
    } else {
        printf("\n[오류] 계좌 정보를 찾을 수 없습니다.\n");
    }
}

/* 3. 입금 함수 (+ 거래내역 저장) */
void do_deposit() {
    printf("\n입금하실 금액을 입력하세요: ");
    scanf("%ld", &amount);
    
    if (amount <= 0) {
        printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
        return;
    }

    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE + :amount WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        /* 한글 리터럴 대신 변수 사용 */
        strcpy(trans_type, "입금");
        EXEC SQL INSERT INTO TRANSACTION_HISTORY (ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:acc_no, :trans_type, :amount);
        
        if (sqlca.sqlcode == 0) {
            EXEC SQL COMMIT;
            printf("[성공] %s원이 입금되었습니다.\n", format_comma(amount));
        } else {
            EXEC SQL ROLLBACK;
            printf("[오류] 거래내역 저장 실패 (Code: %d)\n", sqlca.sqlcode);
        }
    } else {
        EXEC SQL ROLLBACK;
        printf("[오류] 입금 처리 실패.\n");
    }
}

/* 4. 출금 함수 (+ 거래내역 저장) */
void do_withdraw() {
    printf("\n출금하실 금액을 입력하세요: ");
    scanf("%ld", &amount);

    if (amount <= 0) {
        printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
        return;
    }

    EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
    
    if (current_balance < amount) {
        printf("[실패] 잔액이 부족합니다. (현재 잔액: %ld원)\n", current_balance);
        return;
    }

    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE - :amount WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        /* 한글 리터럴 대신 변수 사용 */
        strcpy(trans_type, "출금");
        EXEC SQL INSERT INTO TRANSACTION_HISTORY (ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:acc_no, :trans_type, :amount);

        if (sqlca.sqlcode == 0) {
            EXEC SQL COMMIT;
            printf("[성공] %s원이 정상적으로 출금되었습니다.\n", format_comma(amount));
        } else {
            EXEC SQL ROLLBACK;
            printf("[오류] 거래내역 저장 실패 (Code: %d)\n", sqlca.sqlcode);
        }
    } else {
        EXEC SQL ROLLBACK;
        printf("[오류] 출금 처리 실패.\n");
    }
}

// 5. 계좌 이체 함수
void do_transfer(){
    printf("\n송금받을 계좌번호를 입력하세요: ");
    scanf("%s", target_acc);

    // 본인 계좌로 이체 방지
    if(strcmp(acc_no, target_acc) == 0){
        printf("[오류] 본인 계좌로는 이체할 수 없습니다.\n");
        return;
    }

    //상대방 계좌 존재 여부 및 이름 확인
    EXEC SQL SELECT USER_NAME INTO :target_name FROM ACCOUNT WHERE ACC_NO = :target_acc;
    if(sqlca.sqlcode != 0){
        printf("[오류] 존재하지 않는 계좌번호입니다.\n");
        return;
    }
    target_name.arr[target_name.len] = '\0';

    printf("이체하실 금액을 입력하세요: ");
    scanf("%ld", &amount);

    if(amount <= 0){
        printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
        return;
    }

    // 내 계좌 잔액 확인
    EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
    if(current_balance < amount){
        printf("[실패] 잔액이 부족합니다. (현재 잔액: %s원)\n", format_comma(current_balance));
        return;
    }

    printf("\n[%s] 님에게 %s원을 이체합니다. 진행 중...\n", target_name.arr, format_comma(amount));

    //1. 내 계좌 출금
    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE - :amount WHERE ACC_NO = :acc_no;
    if (sqlca.sqlcode != 0) goto transfer_rollback;

    // 2. 상대방 계좌 입금
    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE + :amount WHERE ACC_NO = :target_acc;
    if (sqlca.sqlcode != 0) goto transfer_rollback;

    // 3. 내 거래내역 저장
    strcpy(trans_type, "이체출금");
    EXEC SQL INSERT INTO TRANSACTION_HISTORY (ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:acc_no, :trans_type, :amount);
    if(sqlca.sqlcode != 0) goto transfer_rollback;

    // 4. 상대방 거래내역 저장
    strcpy(trans_type, "이체입금");
    EXEC SQL INSERT INTO TRANSACTION_HISTORY(ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:target_acc, :trans_type, :amount);
    if(sqlca.sqlcode != 0) goto transfer_rollback;

    // 모든 과정이 성공하면 COMMIT
    EXEC SQL COMMIT;
    printf("[성공] 이체가 완료되었습니다!\n");
    return;

    transfer_rollback:
    // 중간에 하나라도 실패하면 모두 취소
    EXEC SQL ROLLBACK;
    printf("[오류] 이체 처리 중 문제가 발생하여 모든 작업이 취소되었습니다. (Code: %d) \n", sqlca.sqlcode);
}

/* ================= 메인 함수 ================= */
int main() {
    putenv("NLS_LANG=KOREAN_KOREA.AL32UTF8");
    int choice;

    printf("1. 시스템 부팅 중...\n");

    EXEC SQL CONNECT :user_id;
    if (sqlca.sqlcode < 0) sql_error("DB 연결 실패!");
    printf("2. 오라클 DB 연결 성공!\n");

    while(!login()) {
        printf("다시 시도해주세요.\n");
    }

    while(1) {
        printf("\n========== C-STOCK ATM ==========\n");
        printf(" 1. 잔액조회  2. 입금  3. 출금  4. 계좌이체  5. 종료\n");
        printf("=================================\n");
        printf("메뉴를 선택하세요: ");
        scanf("%d", &choice);

        if (choice == 5) {
            printf("\n이용해 주셔서 감사합니다. 시스템을 종료합니다.\n");
            break;
        }

        switch(choice) {
            case 1: check_balance(); break;
            case 2: do_deposit(); break;
            case 3: do_withdraw(); break;
            case 4: do_transfer(); break;
            default: printf("\n[경고] 잘못된 메뉴를 선택하셨습니다. (1~5 입력)\n");
        }
    }

    EXEC SQL COMMIT WORK RELEASE;
    return 0;
}